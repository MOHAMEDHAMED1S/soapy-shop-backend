# نظام الخصومات وأكواد الخصم - Soapy Shop

## 📋 نظرة عامة

نظام خصومات متكامل يتيح إدارة أكواد الخصم بمرونة عالية مع تتبع الاستخدام والإحصائيات المفصلة.

## 🏗️ هيكل النظام

### الجداول

#### 1. جدول أكواد الخصم (`discount_codes`)

```sql
- id: معرف فريد
- code: كود الخصم (فريد)
- name: اسم كود الخصم
- description: وصف كود الخصم
- type: نوع الخصم (percentage, fixed_amount, free_shipping)
- value: قيمة الخصم
- minimum_order_amount: الحد الأدنى للطلب
- maximum_discount_amount: الحد الأقصى للخصم
- usage_limit: حد الاستخدام الإجمالي
- usage_count: عدد مرات الاستخدام الحالي
- usage_limit_per_customer: حد الاستخدام لكل عميل
- is_active: حالة التفعيل
- starts_at: تاريخ البداية
- expires_at: تاريخ الانتهاء
- applicable_categories: الفئات المنطبقة
- applicable_products: المنتجات المنطبقة
- applicable_customers: العملاء المنطبقون
- first_time_customer_only: للعملاء الجدد فقط
- new_customer_only: للعملاء الجدد فقط
- admin_notes: ملاحظات المدير
```

#### 2. جدول استخدام أكواد الخصم (`discount_code_usage`)

```sql
- id: معرف فريد
- discount_code_id: معرف كود الخصم
- order_id: معرف الطلب
- customer_id: معرف العميل
- discount_amount: مبلغ الخصم
- order_amount_before_discount: مبلغ الطلب قبل الخصم
- order_amount_after_discount: مبلغ الطلب بعد الخصم
- customer_phone: رقم هاتف العميل
- customer_email: بريد العميل الإلكتروني
- used_at: تاريخ الاستخدام
```

## 🎯 أنواع الخصومات

### 1. خصم نسبة مئوية (Percentage)
- **القيمة**: نسبة مئوية (0-100)
- **المثال**: خصم 20% على الطلب
- **الحد الأقصى**: يمكن تحديد حد أقصى لمبلغ الخصم

### 2. خصم مبلغ ثابت (Fixed Amount)
- **القيمة**: مبلغ ثابت بالدينار الكويتي
- **المثال**: خصم 15 د.ك من الطلب
- **الحد الأقصى**: لا يمكن أن يتجاوز مبلغ الطلب

### 3. شحن مجاني (Free Shipping)
- **القيمة**: 0 (يتم التعامل معه بشكل منفصل)
- **المثال**: شحن مجاني على الطلبات
- **الشروط**: يمكن تحديد حد أدنى للطلب

## 🔧 الميزات المتقدمة

### شروط التطبيق

1. **الحد الأدنى للطلب**: مبلغ أدنى مطلوب لتطبيق الخصم
2. **الفئات المحددة**: تطبيق الخصم على فئات معينة فقط
3. **المنتجات المحددة**: تطبيق الخصم على منتجات معينة فقط
4. **العملاء المحددون**: تطبيق الخصم على عملاء معينين فقط
5. **العملاء الجدد فقط**: تطبيق الخصم على العملاء الجدد فقط
6. **العملاء لأول مرة**: تطبيق الخصم على العملاء لأول مرة فقط

### حدود الاستخدام

1. **الحد الإجمالي**: عدد مرات الاستخدام الإجمالي
2. **الحد لكل عميل**: عدد مرات الاستخدام لكل عميل
3. **تتبع الاستخدام**: تسجيل كل استخدام مع التفاصيل

### فترات الصلاحية

1. **تاريخ البداية**: متى يصبح الكود فعالاً
2. **تاريخ الانتهاء**: متى ينتهي الكود
3. **التفعيل اليدوي**: إمكانية تفعيل/إلغاء تفعيل الكود

## 📡 APIs المتاحة

### APIs العملاء

#### 1. جلب أكواد الخصم المتاحة
```http
GET /api/v1/discount-codes
```

**المعاملات:**
- `type`: نوع الخصم (percentage, fixed_amount, free_shipping)
- `limit`: عدد النتائج (افتراضي: 10)

#### 2. تفاصيل كود خصم محدد
```http
GET /api/v1/discount-codes/{code}
```

#### 3. التحقق من صحة كود الخصم
```http
POST /api/v1/discount-codes/validate
```

**المعاملات:**
```json
{
    "code": "WELCOME10",
    "items": [
        {
            "product_id": 1,
            "quantity": 2
        }
    ],
    "customer_phone": "+96512345678"
}
```

### APIs المدير

#### 1. إدارة أكواد الخصم
```http
GET /api/v1/admin/discount-codes
POST /api/v1/admin/discount-codes
GET /api/v1/admin/discount-codes/{id}
PUT /api/v1/admin/discount-codes/{id}
DELETE /api/v1/admin/discount-codes/{id}
```

#### 2. إحصائيات أكواد الخصم
```http
GET /api/v1/admin/discount-codes/statistics
```

#### 3. إدارة حالة الكود
```http
PUT /api/v1/admin/discount-codes/{id}/toggle-status
```

#### 4. تاريخ الاستخدام
```http
GET /api/v1/admin/discount-codes/{id}/usage-history
```

#### 5. نسخ كود خصم
```http
POST /api/v1/admin/discount-codes/{id}/duplicate
```

## 🛠️ أوامر Artisan

### إدارة أكواد الخصم
```bash
php artisan app:discount-code-management {action}
```

**الأفعال المتاحة:**
- `list`: عرض قائمة أكواد الخصم
- `create`: إنشاء كود خصم جديد
- `stats`: عرض الإحصائيات
- `cleanup`: تنظيف الأكواد المنتهية
- `test`: اختبار كود خصم

**أمثلة:**
```bash
# عرض قائمة الأكواد
php artisan app:discount-code-management list

# إنشاء كود خصم جديد
php artisan app:discount-code-management create --code=SAVE15 --name="وفر 15%" --type=percentage --value=15

# عرض الإحصائيات
php artisan app:discount-code-management stats

# اختبار كود خصم
php artisan app:discount-code-management test --code=WELCOME10
```

## 📊 الإحصائيات والتقارير

### إحصائيات عامة
- إجمالي أكواد الخصم
- الأكواد النشطة
- الأكواد المنتهية
- الأكواد المستخدمة

### إحصائيات الفترة
- إجمالي الاستخدام
- إجمالي مبلغ الخصم
- متوسط الخصم لكل استخدام

### تقارير مفصلة
- أكثر الأكواد استخداماً
- الاستخدام حسب النوع
- تاريخ الاستخدام
- أداء الأكواد

## 🔒 الأمان والتحقق

### التحقق من صحة الكود
1. **وجود الكود**: التأكد من وجود الكود
2. **حالة التفعيل**: التأكد من أن الكود نشط
3. **فترة الصلاحية**: التأكد من أن الكود لم ينته
4. **حد الاستخدام**: التأكد من عدم تجاوز الحد
5. **شروط العميل**: التحقق من أهلية العميل
6. **شروط المنتج**: التحقق من تطبيق الكود على المنتجات
7. **الحد الأدنى للطلب**: التحقق من الحد الأدنى

### تتبع الاستخدام
- تسجيل كل استخدام
- ربط الاستخدام بالطلب والعميل
- تتبع مبلغ الخصم
- تسجيل التاريخ والوقت

## 🎨 أمثلة الاستخدام

### إنشاء كود خصم ترحيبي
```php
$discountCode = DiscountCode::createPercentageDiscount(
    'WELCOME10',
    'خصم ترحيبي 10%',
    10,
    [
        'minimum_order_amount' => 50,
        'maximum_discount_amount' => 25,
        'usage_limit' => 100,
        'first_time_customer_only' => true,
        'expires_at' => now()->addDays(30),
    ]
);
```

### إنشاء كود خصم مبلغ ثابت
```php
$discountCode = DiscountCode::createFixedAmountDiscount(
    'SAVE15KWD',
    'وفر 15 د.ك',
    15,
    [
        'minimum_order_amount' => 75,
        'usage_limit' => 30,
        'expires_at' => now()->addDays(20),
    ]
);
```

### إنشاء كود شحن مجاني
```php
$discountCode = DiscountCode::createFreeShippingDiscount(
    'FREESHIP',
    'شحن مجاني',
    [
        'minimum_order_amount' => 25,
        'usage_limit' => 200,
        'expires_at' => now()->addDays(45),
    ]
);
```

### التحقق من صحة الكود
```php
$result = $discountService->validateAndApplyDiscountCode(
    'WELCOME10',
    [
        'items' => [
            ['product_id' => 1, 'quantity' => 2],
            ['product_id' => 2, 'quantity' => 1],
        ],
        'customer_phone' => '+96512345678'
    ],
    $customer
);

if ($result['success']) {
    $discountAmount = $result['discount_amount'];
    $finalAmount = $result['order_amount_after_discount'];
}
```

## 🚀 التطوير المستقبلي

### ميزات مخططة
1. **أكواد الخصم التلقائية**: إنشاء أكواد تلقائياً بناءً على شروط معينة
2. **خصومات متدرجة**: خصومات تزداد مع زيادة مبلغ الطلب
3. **خصومات مجمعة**: إمكانية استخدام عدة أكواد خصم معاً
4. **خصومات موسمية**: خصومات تظهر في أوقات معينة
5. **خصومات شخصية**: خصومات مخصصة لكل عميل
6. **إشعارات الخصم**: إشعارات العملاء بأكواد الخصم المتاحة
7. **تحليلات متقدمة**: تحليلات مفصلة لأداء أكواد الخصم

### تحسينات الأداء
1. **فهرسة قاعدة البيانات**: تحسين فهرسة الجداول
2. **تخزين مؤقت**: تخزين مؤقت للكودات المستخدمة بكثرة
3. **تحسين الاستعلامات**: تحسين استعلامات قاعدة البيانات
4. **معالجة متوازية**: معالجة متوازية للخصومات الكبيرة

## 📝 ملاحظات مهمة

1. **الأمان**: جميع العمليات محمية بمصادقة المدير
2. **التحقق**: التحقق الشامل من صحة البيانات
3. **السجلات**: تسجيل مفصل لجميع العمليات
4. **الأداء**: تحسين الأداء للعمليات الكبيرة
5. **المرونة**: إمكانية تخصيص النظام حسب الحاجة

## 🔧 استكشاف الأخطاء

### مشاكل شائعة
1. **كود غير صحيح**: التحقق من صحة الكود
2. **كود منتهي**: التحقق من تاريخ الانتهاء
3. **حد الاستخدام**: التحقق من حدود الاستخدام
4. **شروط العميل**: التحقق من أهلية العميل
5. **شروط المنتج**: التحقق من تطبيق الكود على المنتجات

### حلول
1. **فحص السجلات**: مراجعة سجلات النظام
2. **اختبار الكود**: استخدام أمر الاختبار
3. **التحقق من البيانات**: فحص بيانات الكود
4. **مراجعة الشروط**: التأكد من صحة الشروط
5. **اختبار التكامل**: اختبار التكامل مع النظام

---

**تم تطوير نظام الخصومات بواسطة فريق Soapy Shop** 🧼✨
